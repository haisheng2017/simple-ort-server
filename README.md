# simple-ort-server
ONNX runtime server implement by java

一个简易的推理服务

# Development
```
bash init.sh
```
服务端用了另一个仓库的脚手架，要求JDK17。Maven用server文件夹下的wrapper即可。如当前Path下的mvn过旧，可以更改脚本中的mvn命令变为实际位置的mvnw，重点是将install的jar包置入local仓库

客户端用了python实现，python>=3.8
## 使用示例
### 编译产出服务端
```
cd server && mvn clean package
java -jar xxxx.jar #你产出的jar的名字
```
### 客户端调用
```
python client/onnx_client.py --host=localhost:8080 -m assets/yolo_nas_s.onnx -f assets/example.jpg
```
## 注意事项
- 该仓库内的图片源于网络
- 该仓库内的onnx来源于 yolo_nas_s 架构，使用的是coco预训练好的权重，直接导出，包含了前处理和后处理算子
- 目前只实现了视觉-目标检测类的接口
- 使用时要确定图片排列是BGR还是RGB，直接导出onnx的需要 (1,3,640,640) 的图片。batch=1, RGB array, 640 * 640 pixels

# 可能需要优化的事项
- 序列化方式，可增加GRPC
- onnx的输入输出千变万化，需要定义模型描述语言，在选用模型时，返回给客户端，客户端根据模型描述语言来决定如何处理输入和输出。也就是自定义配置文件。根据配置文件服务端来进行约束判断
- 曾经想过在服务端执行输入数据的转换，但仔细想想不是很现实。推理不仅仅有图像，可能还有一些TOKEN，这些输入是和onnx的输入定义相关。可以在onnx的前处理算子增加逻辑，例如输入图片的buffer，由onnx前处理进行reshape。通过前处理算子，进行输入归一化
- 对于输出后处理部分，可以用编排类应用处理，做成较为通用的逻辑

---
# 如何打造自己的推理应用？
## 麻将识别（日麻）
### 需求
- 麻将玩法千千万，到底怎么算分？
- 立直麻将小分太多，背板不容易
- 人的记忆会出错，即使常备算分手册也可能忽略某一项
### 功能
- 拍照识别麻将
- 胡牌时能够根据赢家手牌算出得分
### 技术路线
#### 挑选心仪的模型
- 根据功能来看，模型的类型应该是视觉-目标检测类模型，它能够识别麻将牌的位置和牌名，通过牌名和位置来枚举分数
- 我想要以最小代价，实现一个还不错的效果识别能力，这里选择yolo_nas_s，最小架构的模型
#### 数据集与标注集
- 选择好模型架构，那么接下来要进行迁移学习，将麻将牌的数据集（标注好的）喂给事先训练好的权重
- 这里使用了开源的数据集（非常好，我能想到的内容基本上都有人做了）
```
https://universe.roboflow.com/riichimahjongdetection/riichi-mahjong-detection
```
- 当然你也可以直接用上面训练出的模型，但是基于我的实验下来，该网站实现的模型可能不带后处理，并且API格式与实际推理不太相同，最重要的是：不能本地化（要钱！）
- （这个网站做数据处理挺不错的，有很多图像增强能力，页面标注也还算凑合）
- 下载你的数据集格式，这里我用的是Yolo DarkNet（用coco也行，不影响，反正是标注和位置的描述语言，很多训练框架都已经集成了）
#### 迁移训练
- 训练框架，我这里选用了google第一个搜出来的`super_gradients`，确实挺方便，比之前yolo5的要好用一些，但是仍然有些bug还没修。如果你遇到问题了，看一下github issue，里面应该有人解答
```
https://github.com/Deci-AI/super-gradients
```
- 超参数，数据划分等等这些和模型训练相关的内容，全部使用默认或示例。唯一要注意的是，和分类标签相关的内容要全部替换为自己的（麻将牌的牌名）
- 推荐用GPU训练，我的4060跑了300个epoch，跑了5个小时，但是实际收敛在前几十个epoch就已经完成了，后面显示loss基本都在震荡了。可能和数据集比较小有关。
- 将跑好的checkpoint用新的python读一下，跑一下test数据集，看看结果怎么样
#### 导出ONNX
- 导出时，要记录导出结果，会提示输入输出是什么样的，包不包含前后处理（你想导出其他类型也可以，但我这个仓库用不了）
#### 业务流程
- 识别出的麻将要经过多种方式筛选出三个主要内容：手牌（包含胡牌），宝牌指示，公开的牌（吃碰杠）
- 东南西北风、本场的指示可以通过button做掉
- 有以上数据如何计算？自己写也可以，不过当我想到，总有人已经做了。本质上还是打表+全枚举找最大牌力
```
https://github.com/MahjongRepository/mahjong
```
- 我自己做了一个安卓端的，把推理服务集成到安卓上了。不过看上去还是用WEB端好一点，至少在适配多系统时，会简单一些，直接打开H5页面会更方便一点。如果业务很重很大，那我可能会选择TritonServer。我自己实现的这个服务就是简易好维护，甚至不需要使用GPU。
- 展示放在最下面。